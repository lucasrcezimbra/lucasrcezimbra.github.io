<!doctype html><html lang=pt><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Lucas Cezimbra"><meta name=description content="Resposta curta: pyrasite
pip install pyrasite echo 0 | sudo tee /proc/sys/kernel/yama/ptrace_scope pyrasite $PID dump_stacks.py pyrasite-shell &amp;lt;pid> Utilizando pyrasite para injetar código num console Python
Contexto Esses dias estava com um bug intermitente que só ocorria no servidor de desenvolvimento, então não estava conseguindo reproduzir localmente.
Tentando descobrir o problema, dei SSH para o servidor e vi que num processo estava justamente acontecendo o que eu queria corrigir.
Então comecei a tentar debugar o código que já estava em execução, sem ter que recomeçar o processo, pois se fizesse isso provavelmente o bug não iria ocorrer."><meta name=keywords content><meta name=twitter:card content="summary"><meta name=twitter:image content="https://cezimbra.me/images/lucas-180x180.jpg"><meta name=twitter:title content="Python: Como injetar código num processo em execução"><meta name=twitter:description content="Resposta curta: pyrasite
pip install pyrasite echo 0 | sudo tee /proc/sys/kernel/yama/ptrace_scope pyrasite $PID dump_stacks.py pyrasite-shell &amp;lt;pid> Utilizando pyrasite para injetar código num console Python
Contexto Esses dias estava com um bug intermitente que só ocorria no servidor de desenvolvimento, então não estava conseguindo reproduzir localmente.
Tentando descobrir o problema, dei SSH para o servidor e vi que num processo estava justamente acontecendo o que eu queria corrigir.
Então comecei a tentar debugar o código que já estava em execução, sem ter que recomeçar o processo, pois se fizesse isso provavelmente o bug não iria ocorrer."><meta name=twitter:site content="@lucasrcezimbra"><meta property="og:title" content="Python: Como injetar código num processo em execução"><meta property="og:description" content="Resposta curta: pyrasite
pip install pyrasite echo 0 | sudo tee /proc/sys/kernel/yama/ptrace_scope pyrasite $PID dump_stacks.py pyrasite-shell &amp;lt;pid> Utilizando pyrasite para injetar código num console Python
Contexto Esses dias estava com um bug intermitente que só ocorria no servidor de desenvolvimento, então não estava conseguindo reproduzir localmente.
Tentando descobrir o problema, dei SSH para o servidor e vi que num processo estava justamente acontecendo o que eu queria corrigir.
Então comecei a tentar debugar o código que já estava em execução, sem ter que recomeçar o processo, pois se fizesse isso provavelmente o bug não iria ocorrer."><meta property="og:type" content="article"><meta property="og:url" content="https://cezimbra.me/python-como-injetar-codigo-num-processo-em-execucao/"><meta property="og:image" content="https://cezimbra.me/images/lucas-180x180.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-06-13T01:59:02+00:00"><meta property="article:modified_time" content="2019-06-13T01:59:02+00:00"><title>Python: Como injetar código num processo em execução · Lucas Cezimbra</title><link rel=canonical href=https://cezimbra.me/python-como-injetar-codigo-num-processo-em-execucao/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css integrity="sha256-2f3b/+byfmmYXcX+BHHNsOV/v0d1cUvD2Eesywj0ofY=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.002ee2378e14c7a68f1f0a53d9694ed252090987c4e768023fac694a4fc5f793.css integrity="sha256-AC7iN44Ux6aPHwpT2WlO0lIJCYfE52gCP6xpSk/F95M=" crossorigin=anonymous media=screen><link rel=stylesheet href=/styles/custom.min.2ef373c2c125094d9302d8a924eba231d053340611b63bcf581460745cef626f.css integrity="sha256-LvNzwsElCU2TAtipJOuiMdBTNAYRtjvPWBRgdFzvYm8=" crossorigin=anonymous media=screen><link rel=stylesheet href=/styles/project.min.b34629645b77ae2432c104397ae29202077f926d712f2019dfa9034bc78837fa.css integrity="sha256-s0YpZFt3riQywQQ5euKSAgd/km1xLyAZ36kDS8eIN/o=" crossorigin=anonymous media=screen><link rel=stylesheet href=/styles/contribution.min.cc4187dd6677d15a0c4438b74294dbe3f54269e14a831b267fb6f02a24f90d5d.css integrity="sha256-zEGH3WZ30VoMRDi3QpTb4/VCaeFKgxsmf7bwKiT5DV0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/styles/jquery.dataTables.min.min.8f6eae843117db9532d2c9b910f3b28834d22d85107ce9aba8b5abbeab67400a.css integrity="sha256-j26uhDEX25Uy0sm5EPOyiDTSLYUQfOmrqLWrvqtnQAo=" crossorigin=anonymous media=screen><link rel=stylesheet href=/styles/timeline.min.801628785543d9e7f6deb109e9561a48da7823522c0986a7dd47be117447e62f.css integrity="sha256-gBYoeFVD2ef23rEJ6VYaSNp4I1IsCYan3Ue+EXRH5i8=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/lucas-32x32.jpg sizes=32x32><link rel=icon type=image/png href=/images/lucas-16x16.jpg sizes=16x16><link rel=apple-touch-icon href=/images/lucas-180x180.jpg><link rel=apple-touch-icon sizes=180x180 href=/images/lucas-180x180.jpg><meta name=generator content="Hugo 0.106.0"></head><body class="preload-transitions colorscheme-dark"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Lucas Cezimbra</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/sobre/>Sobre</a></li><li class=navigation-item><a class=navigation-link href=/projetos/>Projetos</a></li><li class=navigation-item><a class=navigation-link href=/anotacoes/indice/>Anotações</a></li><li class=navigation-item><a class=navigation-link href=/palestras/>Palestras</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://cezimbra.me/python-como-injetar-codigo-num-processo-em-execucao/>Python: Como injetar código num processo em execução</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2019-06-13T01:59:02Z>junho 13, 2019</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i></span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=/categories/python/>Python</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/debug/>debug</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/linux/>linux</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/python/>python</a></span></div></div></header><div><p>Resposta curta: <a href=https://pyrasite.readthedocs.io/en/latest/>pyrasite</a></p><div class=highlight><pre tabindex=0 style=color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install pyrasite
</span></span><span style=display:flex><span><span style=color:#cd00cd>echo</span> <span style=color:#cd00cd>0</span> | sudo tee /proc/sys/kernel/yama/ptrace_scope
</span></span><span style=display:flex><span>pyrasite <span style=color:#00cdcd>$PID</span> dump_stacks.py
</span></span><span style=display:flex><span>pyrasite-shell &amp;lt;pid&gt;
</span></span></code></pre></div><figure><img src=pyrasite.png alt="Utilizando pyrasite para injetar código num console Python"><figcaption><p>Utilizando pyrasite para injetar código num console Python</p></figcaption></figure><h2 id=contexto>Contexto
<a class=heading-link href=#contexto><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Esses dias estava com um bug intermitente que só ocorria no servidor de desenvolvimento, então não estava conseguindo reproduzir localmente.</p><p>Tentando descobrir o problema, dei SSH para o servidor e vi que num processo estava justamente acontecendo o que eu queria corrigir.</p><p>Então comecei a tentar debugar o código que já estava em execução, sem ter que recomeçar o processo, pois se fizesse isso provavelmente o bug não iria ocorrer.</p><p>Foi assim que descobri o <a href=https://pyrasite.readthedocs.io/en/latest/>pyrasite</a> e como debugar um processo Python que já está em execução.</p><h2 id=pyrasite>Pyrasite
<a class=heading-link href=#pyrasite><i class="fa fa-link" aria-hidden=true></i></a></h2><p>Com o pyrasite conseguimos injetar código em um processo Python e debugar em tempo de execução.</p><p align=center><script id=asciicast-1148 src=https://asciinema.org/a/1148.js async></script></p><p>Fonte: <a href=http://pyrasite.com/>http://pyrasite.com/</a></p><h4 id=instalação>Instalação
<a class=heading-link href=#instala%c3%a7%c3%a3o><i class="fa fa-link" aria-hidden=true></i></a></h4><div class=highlight><pre tabindex=0 style=color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install pyrasite
</span></span></code></pre></div><h4 id=habilitar-o-trace>Habilitar o trace
<a class=heading-link href=#habilitar-o-trace><i class="fa fa-link" aria-hidden=true></i></a></h4><p>No Linux, por uma questão de segurança, o trace é desabilitado por padrão. Então temos que habilitar para conseguir debugar com o pyrasite.</p><div class=highlight><pre tabindex=0 style=color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#cd00cd>echo</span> <span style=color:#cd00cd>0</span> | sudo tee /proc/sys/kernel/yama/ptrace_scope
</span></span></code></pre></div><p>Recomendo voltar o <em>ptrace_scope</em> para o valor padrão (1) após o debug.</p><p>Mais informações sobre o <a href=https://www.kernel.org/doc/Documentation/security/Yama.txt>ptrace_scope na documentação do Kernel</a>.</p><h4 id=utilização>Utilização
<a class=heading-link href=#utiliza%c3%a7%c3%a3o><i class="fa fa-link" aria-hidden=true></i></a></h4><p>Para utilizar o pyrasite chamamos com o ID do Processo (PID) e o script que queremos executar:</p><div class=highlight><pre tabindex=0 style=color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pyrasite <span style=color:#00cdcd>$PID</span> my_script.py
</span></span></code></pre></div><p>A ferramenta já vem com alguns scripts prontos para injetar no processo, são eles:</p><ul><li><a href=https://github.com/lmacken/pyrasite/blob/master/pyrasite/payloads/dump_stacks.py>dump_stacks.py</a>: <em>printa</em> o stacktrace do código executado</li><li><a href=https://github.com/lmacken/pyrasite/blob/master/pyrasite/payloads/dump_modules.py>dump_modules.py</a>: <em>printa</em> os módulos carregados (<a href="https://docs.python.org/3/library/sys.html?highlight=sys#sys.modules">sys.modules</a>)</li><li><a href=https://github.com/lmacken/pyrasite/blob/master/pyrasite/payloads/force_garbage_collection.py>force_garbage_collection.py</a>: força a execução do garbage collector</li><li><a href=https://github.com/lmacken/pyrasite/blob/master/pyrasite/payloads/helloworld.py>helloworld.py</a>: <em>printa</em> Hello World</li><li><a href=https://github.com/lmacken/pyrasite/blob/master/pyrasite/payloads/dump_memory.py><del>dump_memory.py</del></a>: depende de uma lib que não suporta Python 3</li></ul><p>Além desses, também temos <a href=https://github.com/lmacken/pyrasite/blob/master/pyrasite/payloads/reverse_python_shell.py>reverse_python_shell.py</a>, <a href=https://github.com/lmacken/pyrasite/blob/master/pyrasite/payloads/reverse_shell.py>reverse_shell.py</a>, <a href=https://github.com/lmacken/pyrasite/blob/master/pyrasite/payloads/start_callgraph.py>start_callgraph.py</a>, <a href=https://github.com/lmacken/pyrasite/blob/master/pyrasite/payloads/stop_callgraph.py>stop_callgraph.py</a>, mas esses eu não consegui usar e não fui muito a fundo.</p><p>Para, por exemplo, utilizar o <em>dump_stacks.py</em>, rodamos:</p><div class=highlight><pre tabindex=0 style=color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pyrasite <span style=color:#00cdcd>$PID</span> dump_stacks.py
</span></span></code></pre></div><h4 id=shell>Shell
<a class=heading-link href=#shell><i class="fa fa-link" aria-hidden=true></i></a></h4><p>Além de executar scripts, também podemos habilitar um shell Python para depurar o que está acontecendo na aplicação. Com o shell conseguimos rodar comandos, acessar variáveis e tudo mais que fazemos num console Python</p><div class=highlight><pre tabindex=0 style=color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pyrasite-shell <span style=color:#00cdcd>$PID</span>
</span></span></code></pre></div><h2 id=troubleshooting>Troubleshooting
<a class=heading-link href=#troubleshooting><i class="fa fa-link" aria-hidden=true></i></a></h2><ol><li>Rodei o pyrasite e não apareceu nenhum resultado<ul><li>O <em>output</em> do código injetado aparecerá no <em>stdout</em> do processo principal que está recebendo a injeção. Se o seu processo redireciona o <em>stdout</em> para um arquivo, a saída do código injetado também irá para o mesmo arquivo.</li></ul></li></ol></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2022
Lucas Cezimbra
·
<a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.9cf2dbf9b6989ef8eae941ffb4231c26d1dc026bca38f1d19fdba50177d8a9ac.js integrity="sha256-nPLb+baYnvjq6UH/tCMcJtHcAmvKOPHRn9ulAXfYqaw="></script>
<script src=/scripts/jquery-3.6.1.min.min.e7f737b0e490f5e9cd34702be5d567ad9032230146e506a64cc7cc9cec4c6ef6.js integrity="sha256-5/c3sOSQ9enNNHAr5dVnrZAyIwFG5QamTMfMnOxMbvY="></script>
<script src=/scripts/jquery.dataTables.min.min.f90ab97ce924f89a65ac5093e70bfd7feed67d5d3381bccedfdb6d6a3e03cb93.js integrity="sha256-+Qq5fOkk+JplrFCT5wv9f+7WfV0zgbzO39ttaj4Dy5M="></script>
<script data-goatcounter=https://cezimbra.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html>