<!doctype html><html lang=pt><head><title>A lentid√£o no legado que resolvi sem resolver ¬∑ Lucas Cezimbra</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Lucas Cezimbra"><meta name=description content="Como utilizei observabilidade para resolver um problema de performance em um projeto que eu nunca tinha mexido antes"><meta name=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cezimbra.me/images/lucas-180x180.jpg"><meta name=twitter:title content="A lentid√£o no legado que resolvi sem resolver"><meta name=twitter:description content="Como utilizei observabilidade para resolver um problema de performance em um projeto que eu nunca tinha mexido antes"><meta property="og:url" content="https://cezimbra.me/posts/a-lentidao-no-legado-que-resolvi-sem-resolver/"><meta property="og:site_name" content="Lucas Cezimbra"><meta property="og:title" content="A lentid√£o no legado que resolvi sem resolver"><meta property="og:description" content="Como utilizei observabilidade para resolver um problema de performance em um projeto que eu nunca tinha mexido antes"><meta property="og:locale" content="pt"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-09-02T00:00:00+00:00"><meta property="article:modified_time" content="2025-09-02T00:00:00+00:00"><meta property="og:image" content="https://cezimbra.me/images/lucas-180x180.jpg"><link rel=canonical href=https://cezimbra.me/posts/a-lentidao-no-legado-que-resolvi-sem-resolver/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.7ee04855f01a7f7a311ce189708f520a1a1d93c249cfed3b23e8c27666fc546e.css integrity="sha256-fuBIVfAaf3oxHOGJcI9SChodk8JJz+07I+jCdmb8VG4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=stylesheet href=/contribution.min.cc4187dd6677d15a0c4438b74294dbe3f54269e14a831b267fb6f02a24f90d5d.css integrity="sha256-zEGH3WZ30VoMRDi3QpTb4/VCaeFKgxsmf7bwKiT5DV0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/custom.min.2ef373c2c125094d9302d8a924eba231d053340611b63bcf581460745cef626f.css integrity="sha256-LvNzwsElCU2TAtipJOuiMdBTNAYRtjvPWBRgdFzvYm8=" crossorigin=anonymous media=screen><link rel=stylesheet href=/jquery.dataTables.min.min.3b0b9d00b1890ba1fb1472480998b073ad910d4c2a73f5d48fda7c43c21c0b75.css integrity="sha256-OwudALGJC6H7FHJICZiwc62RDUwqc/XUj9p8Q8IcC3U=" crossorigin=anonymous media=screen><link rel=stylesheet href=/project.min.cc15fca9f603b853c828be903488d99afe86c71e40721cc4927e27f7453a4a36.css integrity="sha256-zBX8qfYDuFPIKL6QNIjZmv6Gxx5AchzEkn4n90U6SjY=" crossorigin=anonymous media=screen><link rel=stylesheet href=/timeline.min.801628785543d9e7f6deb109e9561a48da7823522c0986a7dd47be117447e62f.css integrity="sha256-gBYoeFVD2ef23rEJ6VYaSNp4I1IsCYan3Ue+EXRH5i8=" crossorigin=anonymous media=screen><link rel=stylesheet href=/vis-timeline-graph2d.min.min.fdf246c52f0424d937fb4fcb748533abfff41e7872e80c53c6e2c0f5cfa91410.css integrity="sha256-/fJGxS8EJNk3+0/LdIUzq//0Hnhy6AxTxuLA9c+pFBA=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/lucas-32x32.jpg sizes=32x32><link rel=icon type=image/png href=/images/lucas-16x16.jpg sizes=16x16><link rel=apple-touch-icon href=/images/lucas-180x180.jpg><link rel=apple-touch-icon sizes=180x180 href=/images/lucas-180x180.jpg><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body hx-boost=true class="preload-transitions colorscheme-dark"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://cezimbra.me/>Lucas Cezimbra
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/sobre/>Sobre</a></li><li class=navigation-item><a class=navigation-link href=/projetos/>Projetos</a></li><li class=navigation-item><a class=navigation-link href=/anotacoes/indice/>Anota√ß√µes</a></li><li class=navigation-item><a class=navigation-link href=/palestras/>Palestras</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://toolbox.cezimbra.me/>Toolbox ‚Üó</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=/en/>üá∫üá∏</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://cezimbra.me/posts/a-lentidao-no-legado-que-resolvi-sem-resolver/>A lentid√£o no legado que resolvi sem resolver</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2025-09-02T00:00:00Z>setembro 2, 2025
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i></span></div></div></header><div class=post-content><p>Esse post foi originalmente publicado como uma newsletter no Substack. Inscreva-se para receber novos posts diretamente no seu e-mail.</p><iframe src=https://lucasrcezimbra.substack.com/embed width=100% height=320 style="border:1px solid #eee;background:#fff" frameborder=0 scrolling=no></iframe><p>Adoro investigar e resolver problemas de performance. Na edi√ß√£o de hoje, vou contar como resolvi um N+1 que deixava um sistema praticamente inutiliz√°vel.</p><p>Detalhe: era um projeto desconhecido, sem ambiente local, nem testes. Com direito a <em>deploy</em> direto em produ√ß√£o via FTP.</p><p>Se voc√™ lida com c√≥digo legado ou j√° precisou decidir entre o ideal e o poss√≠vel, esse texto pode te trazer bons insights.</p><hr><p>Eu tinha um cliente que atendia h√° alguns anos. Os servi√ßos s√≥ envolviam pequenas altera√ß√µes de <em>layout</em> no site da empresa. Por√©m, dessa vez ele me procurou com um problema diferente.</p><p>Eles estavam com uma lentid√£o no sistema que chamavam de Gerenciador. Acessei para verificar e realmente estava bem lento. Levava cerca de 1 minuto para carregar qualquer p√°gina.</p><h2 id=conhecendo-o-terreno>Conhecendo o terreno
<a class=heading-link href=#conhecendo-o-terreno><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>O sistema era um misto de CMS com CRM. Servia para fazer algumas altera√ß√µes no site da empresa e tamb√©m para gerenciar contatos e clientes.</p><p>O problema era que eu n√£o conhecia nada do sistema. N√£o tinha sido desenvolvido por mim, eu nunca tinha nem visto o c√≥digo. Era escrito em PHP, linguagem que eu n√£o mexia h√° anos. Usava o framework Zend, que eu s√≥ conhecia de nome. E tinha zero versionamento, documenta√ß√£o e testes, pelo menos que eu soubesse.</p><p>Tudo o que eu tinha era o acesso √† hospedagem, que utilizava o cPanel<a href=#notas-de-rodap%c3%a9>¬π</a>, e ao servidor FTP<a href=#notas-de-rodap%c3%a9>¬≤</a>.</p><p>Outro ‚Äúproblema‚Äù, agora pessoal, √© que adoro investigar esse tipo de gargalo nas aplica√ß√µes. Ent√£o, l√° fui eu, na cara, coragem e vontade de me incomodar e aceitei o projeto.</p><h2 id=metendo-a-m√£o-na-massa>Metendo a m√£o na massa
<a class=heading-link href=#metendo-a-m%c3%a3o-na-massa><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>A primeira coisa que fiz foi baixar todo o c√≥digo via FTP e colocar em um reposit√≥rio Git<a href=#notas-de-rodap%c3%a9>¬≥</a>.</p><p>O pr√≥ximo passo foi tentar rodar o projeto localmente. N√£o me recordo exatamente como foi essa etapa, mas lembro que eu n√£o consegui rodar localmente. Na √©poca n√£o existiam o <em>ChatGPT</em> e o <em>Claude Code</em> para ajudar.</p><p>Ent√£o minha pr√≥xima tentativa foi adicionar alguma forma de observabilidade ao sistema diretamente em produ√ß√£o. Felizmente, o cPanel tinha uma integra√ß√£o com o New Relic e o plano gratuito desse era o suficiente para o volume de transa√ß√µes do sistema.</p><p>Consegui adicionar a ferramenta sem mexer no c√≥digo, ou seja, menos risco de quebrar algo.</p><p>Deixei o New Relic rodando uns dias e voltei para conferir.</p><h2 id=diagn√≥stico>Diagn√≥stico
<a class=heading-link href=#diagn%c3%b3stico><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>O New Relic me mostrou exatamente onde estava o problema. Era um cl√°ssico N+1<a href=#notas-de-rodap%c3%a9>‚Å¥</a>.</p><p>Investiguei o c√≥digo e descobri que havia uma consulta no banco de dados para buscar todas as mensagens n√£o lidas. Logo depois havia um <em>loop</em> : para cada mensagem fazia outra consulta para buscar mais dados.</p><p>Esses dados eram utilizados para popular um √≠cone no cabe√ßalho do sistema, presente em todas as p√°ginas, com o n√∫mero de mensagens n√£o lidas.</p><p>Enquanto o sistema tinha 10 ou 100 mensagens n√£o lidas, o impacto era pequeno, por√©m, quando esse n√∫mero cresceu para milhares, o impacto ficou significativo e o que levava milissegundos passou a levar segundos ou at√© minutos.</p><p>Ap√≥s entender o problema, eu precisava de uma solu√ß√£o simples que n√£o precisasse de muitas mudan√ßas no c√≥digo, dada a sua fragilidade.</p><h2 id=solu√ß√£o>Solu√ß√£o
<a class=heading-link href=#solu%c3%a7%c3%a3o><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Optei por adicionar um limite ( <em>LIMIT</em> do SQL) na <em>query</em> que buscava as mensagens n√£o lidas no banco de dados. Agora, ao inv√©s de retornar todas, retornava somente 100. O √≠cone que antes mostrava o n√∫mero total de mensagens passou a mostrar ‚Äú99+‚Äù.</p><p>Voc√™ pode estar se perguntando ‚Äúmas isso n√£o resolve o N+1, resolve?‚Äù e a resposta √© ‚Äún√£o, n√£o resolve‚Äù, ‚Äî at√© onde sei, pode ser que o N+1 esteja at√© hoje em produ√ß√£o ‚Äî mas resolve a lentid√£o e por consequ√™ncia o problema do usu√°rio.</p><p>Eu poderia ter alterado a <em>query</em> para buscar todos os dados de uma s√≥ vez e resolver o N+1? Com certeza, mas o risco de eu quebrar algo no meio do caminho seria muito maior.</p><p>O usu√°rio final n√£o est√° interessado se o c√≥digo faz 1 ou 100 consultas ao banco de dados. O que importa √© a usabilidade e, nesse caso, as 100 consultas n√£o comprometiam o sistema.</p><p>N√£o me entenda mal. N√£o estou advogando entregar c√≥digo com problemas de performance, mas cada situa√ß√£o tem seu contexto. Esta foi a melhor solu√ß√£o poss√≠vel? N√£o, por√©m, considerando as limita√ß√µes, foi boa o suficiente. Lembre-se de que eu estava mexendo em um projeto desconhecido, sem ambiente de desenvolvimento e sem possibilidade de testes.</p><p>Solu√ß√£o pronta. Mas e agora? Como faz para validar e implantar?</p><h2 id=implanta√ß√£o>Implanta√ß√£o
<a class=heading-link href=#implanta%c3%a7%c3%a3o><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Eu s√≥ tinha uma forma de validar minha solu√ß√£o: testar em produ√ß√£o (evitem fazer isso em casa!).</p><p>Escolhi uma hora fora do hor√°rio comercial; abri ambas as vers√µes (antes e depois das minhas modifica√ß√µes), caso houvesse algum problema, eu poderia reverter rapidamente; abri o sistema no navegador; e finalmente abri o FTP e enviei os arquivos modificados.</p><p>E n√£o √© que funcionou?</p><p>O sistema estava abrindo em um tempo aceit√°vel. O √≠cone mostrava ‚Äú99+‚Äù mensagens n√£o lidas.</p><p><img src=/posts/a-lentidao-no-legado-que-resolvi-sem-resolver/99.webp alt></p><p>Comuniquei ao cliente e continuei monitorando com o New Relic por mais alguns dias para garantir que o problema estava resolvido e nenhum outro havia aparecido.</p><p>Sucesso!</p><h2 id=o-que-eu-faria-diferente>O que eu faria diferente?
<a class=heading-link href=#o-que-eu-faria-diferente><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Olhando para tr√°s, eu faria algumas coisas diferentes.</p><p>C√≥digo sem testes; desenvolvimento sem conseguir rodar localmente; valida√ß√£o em produ√ß√£o; implanta√ß√£o via FTP. Essas foram pr√°ticas, no m√≠nimo, question√°veis.</p><p>N√£o vou dizer que n√£o repetiria algumas das mesmas pr√°ticas, se necess√°rio. Em empresas onde software n√£o √© a atividade-fim, √†s vezes, o c√≥digo rodando em produ√ß√£o √© tudo o que se tem.</p><p>O que eu com certeza faria diferente √© que, atualmente, com mais maturidade, eu me preocuparia muito mais em gerenciar os riscos e principalmente comunic√°-los ao cliente. Deixaria clara a situa√ß√£o do projeto e os riscos envolvidos. Ofereceria diferentes op√ß√µes para lidar com o problema e seus respectivos pr√≥s e contras.</p><p>Outra coisa que faria diferente √© a precifica√ß√£o. Cobrei um valor fixo para resolver o problema, assumindo todo o risco do projeto. Atualmente, eu cobraria um valor por hora, dividindo o risco.</p><h2 id=aprendizados>Aprendizados
<a class=heading-link href=#aprendizados><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Podemos tirar algumas li√ß√µes dessa hist√≥ria. A primeira √© que n√£o existe software que n√£o precise de manuten√ß√£o. Esse sistema espec√≠fico rodou tranquilamente por anos at√© que, de repente, um problema que sempre esteve ali o tornou praticamente inutiliz√°vel.</p><p>A segunda li√ß√£o √© o valor de uma boa observabilidade. Adicionar o New Relic ao projeto me possibilitou encontrar facilmente o problema em meio a milhares de linhas de um c√≥digo desconhecido, em uma linguagem e framework com os quais tenho pouca experi√™ncia.</p><p>A terceira li√ß√£o √© que a melhor solu√ß√£o depende do contexto. Em um mundo ideal, eu teria refatorado a query para eliminar o N+1. No mundo real, com c√≥digo legado, sem testes e sem ambiente local, adicionar um simples LIMIT foi a decis√£o mais inteligente.</p><h2 id=conclus√£o>Conclus√£o
<a class=heading-link href=#conclus%c3%a3o><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>No fim, deu tudo certo. Consegui resolver o problema do cliente e o desafio foi bem legal. Gosto bastante de investigar e resolver esse tipo de problema de performance.</p><p>E a√≠, o que achou da solu√ß√£o? Voc√™ teria arriscado resolver completamente o N+1 ou tamb√©m teria ido pelo caminho mais conservador? J√° passou por alguma situa√ß√£o similar? <a href=https://lucasrcezimbra.substack.com/p/a-lentidao-no-legado-que-resolvi/comments class=external-link target=_blank rel=noopener>Deixe um coment√°rio no Substack</a> e vamos conversar.</p><p>Voc√™ est√° com algum problema desse tipo no seu projeto? √Äs vezes, algu√©m vendo o problema de fora pode ajudar. Me mande uma mensagem contando um problema t√©cnico que voc√™ est√° enfrentando e quem sabe a pr√≥xima newsletter √© contando como eu te ajudei.</p><hr><h2 id=notas-de-rodap√©>Notas de Rodap√©
<a class=heading-link href=#notas-de-rodap%c3%a9><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>¬π <strong>cPanel</strong> √© um painel de controle baseado na web usado para gerenciar servidores e hospedagem de sites.</p><p>¬≤ <strong>FTP</strong> √© um protocolo usado para transferir arquivos entre um computador local e um servidor. Ele √© bastante usado em hospedagens de sites para enviar ou atualizar arquivos no servidor. Hoje em dia √© bem menos do que no passado.</p><p>¬≥ <strong>Git</strong> √© um sistema de controle de vers√£o que permite rastrear mudan√ßas em arquivos (principalmente de c√≥digo).</p><p>‚Å¥ <strong>N+1</strong> √© um problema comum em consultas a banco de dados. Acontece quando o sistema faz 1 consulta principal para buscar uma lista de registros e, depois, para cada item dessa lista, faz mais 1 consulta para buscar dados relacionados. Isso gera muitas queries desnecess√°rias e pode deixar o sistema lento.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>¬©
2025
Lucas Cezimbra
¬∑
<a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script src=/js/htmx.min.c4fce4dc5cc9c8c3c9bf1aa788d54bb2cb25cd27114eb06551494ff61c30d6fb.js integrity="sha256-xPzk3FzJyMPJvxqniNVLssslzScRTrBlUUlP9hww1vs="></script><script src=/jquery-3.6.1.min.min.8985a8985a8bab0c06c0f4036f1a7dcb928dc0822c1d50517a1c6538f25c87db.js integrity="sha256-iYWomFqLqwwGwPQDbxp9y5KNwIIsHVBRehxlOPJch9s="></script><script src=/jquery.dataTables.min.min.91ecb48a0f76a338b289bdd8fbdb28c71ef115955c3c0bef49a142fa6cab11ec.js integrity="sha256-key0ig92oziyib3Y+9soxx7xFZVcPAvvSaFC+myrEew="></script><script src=/vis-timeline-graph2d.min.min.cad7d97613f14d1e7fa62ab9a305afdb860fe35e05d1eddae1c204b64ffb4910.js integrity="sha256-ytfZdhPxTR5/piq5owWv24YP414F0e3a4cIEtk/7SRA="></script><script data-goatcounter=https://cezimbra.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html>